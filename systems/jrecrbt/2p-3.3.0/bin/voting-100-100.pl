test(MVIs):-
	update([happens(propose(40,4),0),happens(propose(50,6),0),happens(propose(50,10),0),happens(propose(70,10),0),happens(propose(30,7),0),happens(propose(60,8),0),happens(propose(80,2),0),happens(propose(10,7),0),happens(propose(20,1),0),happens(propose(20,3),0),happens(propose(60,2),0),happens(propose(20,9),0),happens(propose(23,5),1),happens(propose(47,9),1),happens(propose(23,3),1),happens(propose(70,4),1),happens(propose(3,9),1),happens(propose(50,10),1),happens(propose(47,1),1),happens(propose(36,10),1),happens(propose(70,6),1),happens(propose(38,1),1),happens(propose(16,2),1),happens(propose(48,7),1),happens(propose(78,9),1),happens(propose(1,4),1),happens(propose(89,1),1),happens(propose(86,1),1),happens(propose(59,5),1),happens(propose(83,1),1),happens(close_ballot(70,10),2),happens(second(40,4),3),happens(second(30,7),3),happens(second(70,2),3),happens(second(30,5),3),happens(second(10,9),3),happens(second(10,9),3),happens(second(60,4),3),happens(second(90,3),3),happens(second(50,9),3),happens(second(30,4),3),happens(second(50,7),3),happens(second(30,10),3),happens(second(60,6),3),happens(second(50,7),3),happens(second(70,9),3),happens(second(20,5),3),happens(second(10,10),3),happens(close_ballot(90,10),7),happens(close_ballot(80,5),7),happens(close_ballot(0,6),7),happens(close_ballot(30,1),7),happens(declare(30,2,not_carried),8),happens(declare(10,3,not_carried),8),happens(declare(70,1,not_carried),8),happens(declare(90,6,not_carried),8),happens(declare(70,1,not_carried),8),happens(declare(30,5,not_carried),8),happens(declare(80,10,not_carried),8),happens(declare(40,1,not_carried),8),happens(declare(20,2,not_carried),8),happens(declare(80,10,not_carried),8),happens(declare(10,3,not_carried),8),happens(declare(30,2,not_carried),8),happens(declare(10,9,not_carried),8),happens(declare(30,7,not_carried),8),happens(declare(50,8,not_carried),8),happens(declare(70,5,carried),9),happens(declare(0,9,carried),9),happens(declare(70,9,carried),9),happens(declare(80,7,carried),9),happens(declare(20,2,carried),9),happens(declare(40,10,carried),9),happens(declare(0,3,carried),9),happens(declare(70,2,carried),9),happens(declare(20,5,carried),9),happens(declare(10,3,carried),9),happens(declare(50,3,carried),9),happens(declare(80,6,carried),9),happens(declare(0,2,carried),9),happens(propose(20,6),10),happens(propose(90,8),10),happens(propose(90,1),10),happens(propose(20,8),10),happens(propose(20,8),10),happens(propose(70,4),10),happens(propose(90,3),10),happens(propose(60,6),10),happens(propose(80,2),10),happens(propose(90,9),10),happens(propose(30,7),10),happens(propose(50,2),10),happens(propose(96,5),11),happens(propose(85,8),11),happens(propose(42,9),11),happens(propose(2,6),11),happens(propose(91,6),11),happens(propose(31,6),11),happens(propose(84,9),11),happens(propose(23,8),11),happens(propose(36,2),11),happens(propose(27,1),11),happens(propose(40,7),11),happens(propose(45,9),11),happens(propose(94,2),11),happens(propose(90,8),11),happens(propose(63,7),11),happens(propose(47,7),11),happens(propose(15,2),11),happens(propose(86,8),11),happens(close_ballot(30,7),12),happens(second(10,4),13),happens(second(50,3),13),happens(second(50,2),13),happens(second(60,4),13),happens(second(90,10),13),happens(second(90,10),13),happens(second(40,5),13),happens(second(70,7),13),happens(second(40,6),13),happens(second(40,2),13),happens(second(80,8),13),happens(second(10,4),13),happens(second(40,9),13),happens(second(80,5),13),happens(second(70,7),13),happens(second(60,4),13),happens(second(60,8),13),happens(close_ballot(90,7),17),happens(close_ballot(80,6),17),happens(close_ballot(50,5),17),happens(close_ballot(10,6),17),happens(declare(90,8,not_carried),18),happens(declare(30,3,not_carried),18),happens(declare(30,3,not_carried),18),happens(declare(60,4,not_carried),18),happens(declare(50,10,not_carried),18),happens(declare(50,4,not_carried),18),happens(declare(70,9,not_carried),18),happens(declare(20,8,not_carried),18),happens(declare(50,3,not_carried),18),happens(declare(90,3,not_carried),18),happens(declare(70,10,not_carried),18),happens(declare(90,3,not_carried),18),happens(declare(40,9,not_carried),18),happens(declare(30,6,not_carried),18),happens(declare(40,7,not_carried),18),happens(declare(40,8,carried),19),happens(declare(20,5,carried),19),happens(declare(80,7,carried),19),happens(declare(70,6,carried),19),happens(declare(70,7,carried),19),happens(declare(30,10,carried),19),happens(declare(90,9,carried),19),happens(declare(50,7,carried),19),happens(declare(70,4,carried),19),happens(declare(0,7,carried),19),happens(declare(70,5,carried),19),happens(declare(80,6,carried),19),happens(declare(60,10,carried),19),happens(propose(80,10),20),happens(propose(70,6),20),happens(propose(70,6),20),happens(propose(80,2),20),happens(propose(30,3),20),happens(propose(90,1),20),happens(propose(70,9),20),happens(propose(50,7),20),happens(propose(10,8),20),happens(propose(20,4),20),happens(propose(20,4),20),happens(propose(60,7),20),happens(propose(17,4),21),happens(propose(90,1),21),happens(propose(82,4),21),happens(propose(40,9),21),happens(propose(20,2),21),happens(propose(4,6),21),happens(propose(15,10),21),happens(propose(27,1),21),happens(propose(29,3),21),happens(propose(60,8),21),happens(propose(21,5),21),happens(propose(15,7),21),happens(propose(41,5),21),happens(propose(59,7),21),happens(propose(10,6),21),happens(propose(97,5),21),happens(propose(1,6),21),happens(propose(78,1),21),happens(close_ballot(90,5),22),happens(second(40,6),23),happens(second(40,8),23),happens(second(40,9),23),happens(second(10,3),23),happens(second(50,2),23),happens(second(40,5),23),happens(second(30,8),23),happens(second(60,9),23),happens(second(70,1),23),happens(second(20,2),23),happens(second(70,5),23),happens(second(90,1),23),happens(second(70,2),23),happens(second(50,9),23),happens(second(80,9),23),happens(second(60,6),23),happens(second(20,1),23),happens(close_ballot(20,3),27),happens(close_ballot(70,4),27),happens(close_ballot(40,9),27),happens(close_ballot(80,3),27),happens(declare(30,7,not_carried),28),happens(declare(30,7,not_carried),28),happens(declare(40,9,not_carried),28),happens(declare(70,3,not_carried),28),happens(declare(0,2,not_carried),28),happens(declare(0,6,not_carried),28),happens(declare(40,2,not_carried),28),happens(declare(30,7,not_carried),28),happens(declare(20,8,not_carried),28),happens(declare(70,8,not_carried),28),happens(declare(0,9,not_carried),28),happens(declare(90,6,not_carried),28),happens(declare(90,10,not_carried),28),happens(declare(90,3,not_carried),28),happens(declare(80,4,not_carried),28),happens(declare(70,6,carried),29),happens(declare(90,8,carried),29),happens(declare(90,10,carried),29),happens(declare(90,3,carried),29),happens(declare(80,4,carried),29),happens(declare(80,8,carried),29),happens(declare(50,6,carried),29),happens(declare(50,5,carried),29),happens(declare(60,4,carried),29),happens(declare(70,7,carried),29),happens(declare(50,2,carried),29),happens(declare(60,1,carried),29),happens(declare(80,4,carried),29),happens(propose(80,1),30),happens(propose(10,1),30),happens(propose(10,3),30),happens(propose(30,1),30),happens(propose(50,2),30),happens(propose(40,5),30),happens(propose(50,7),30),happens(propose(10,9),30),happens(propose(80,4),30),happens(propose(70,9),30),happens(propose(40,3),30),happens(propose(10,1),30),happens(propose(51,1),31),happens(propose(52,6),31),happens(propose(16,6),31),happens(propose(43,3),31),happens(propose(46,6),31),happens(propose(87,8),31),happens(propose(90,8),31),happens(propose(3,2),31),happens(propose(36,6),31),happens(propose(90,1),31),happens(propose(23,1),31),happens(propose(65,9),31),happens(propose(52,2),31),happens(propose(21,5),31),happens(propose(1,5),31),happens(propose(61,6),31),happens(propose(34,5),31),happens(propose(62,3),31),happens(close_ballot(90,8),32),happens(second(50,4),33),happens(second(90,3),33),happens(second(40,2),33),happens(second(20,5),33),happens(second(50,4),33),happens(second(60,10),33),happens(second(70,7),33),happens(second(90,8),33),happens(second(60,5),33),happens(second(20,2),33),happens(second(50,2),33),happens(second(50,8),33),happens(second(70,3),33),happens(second(90,9),33),happens(second(60,8),33),happens(second(80,4),33),happens(second(90,3),33),happens(close_ballot(40,10),37),happens(close_ballot(50,5),37),happens(close_ballot(60,4),37),happens(close_ballot(70,9),37),happens(declare(40,1,not_carried),38),happens(declare(0,3,not_carried),38),happens(declare(80,3,not_carried),38),happens(declare(70,4,not_carried),38),happens(declare(40,1,not_carried),38),happens(declare(80,10,not_carried),38),happens(declare(70,5,not_carried),38),happens(declare(90,2,not_carried),38),happens(declare(70,2,not_carried),38),happens(declare(40,8,not_carried),38),happens(declare(80,6,not_carried),38),happens(declare(10,7,not_carried),38),happens(declare(20,7,not_carried),38),happens(declare(20,10,not_carried),38),happens(declare(10,1,not_carried),38),happens(declare(60,3,carried),39),happens(declare(40,6,carried),39),happens(declare(80,10,carried),39),happens(declare(80,4,carried),39),happens(declare(0,8,carried),39),happens(declare(0,3,carried),39),happens(declare(10,8,carried),39),happens(declare(0,9,carried),39),happens(declare(30,2,carried),39),happens(declare(70,2,carried),39),happens(declare(20,10,carried),39),happens(declare(10,4,carried),39),happens(declare(40,9,carried),39),happens(propose(70,1),40),happens(propose(20,8),40),happens(propose(90,5),40),happens(propose(60,2),40),happens(propose(20,4),40),happens(propose(60,9),40),happens(propose(80,5),40),happens(propose(90,10),40),happens(propose(40,8),40),happens(propose(40,8),40),happens(propose(10,7),40),happens(propose(40,1),40),happens(propose(80,10),41),happens(propose(90,1),41),happens(propose(35,10),41),happens(propose(60,4),41),happens(propose(96,3),41),happens(propose(76,4),41),happens(propose(42,2),41),happens(propose(37,7),41),happens(propose(90,3),41),happens(propose(48,10),41),happens(propose(93,4),41),happens(propose(49,10),41),happens(propose(48,10),41),happens(propose(50,9),41),happens(propose(37,5),41),happens(propose(81,2),41),happens(propose(48,6),41),happens(propose(51,10),41),happens(close_ballot(30,1),42),happens(second(30,6),43),happens(second(90,8),43),happens(second(70,10),43),happens(second(60,5),43),happens(second(20,2),43),happens(second(10,10),43),happens(second(60,5),43),happens(second(20,1),43),happens(second(10,4),43),happens(second(80,7),43),happens(second(30,6),43),happens(second(60,4),43),happens(second(30,4),43),happens(second(40,6),43),happens(second(80,4),43),happens(second(80,6),43),happens(second(90,7),43),happens(close_ballot(20,7),47),happens(close_ballot(50,6),47),happens(close_ballot(0,9),47),happens(close_ballot(80,3),47),happens(declare(90,5,not_carried),48),happens(declare(80,8,not_carried),48),happens(declare(30,3,not_carried),48),happens(declare(0,4,not_carried),48),happens(declare(70,4,not_carried),48),happens(declare(80,8,not_carried),48),happens(declare(90,5,not_carried),48),happens(declare(40,8,not_carried),48),happens(declare(70,10,not_carried),48),happens(declare(0,4,not_carried),48),happens(declare(80,2,not_carried),48),happens(declare(30,8,not_carried),48),happens(declare(70,1,not_carried),48),happens(declare(90,8,not_carried),48),happens(declare(20,6,not_carried),48),happens(declare(50,2,carried),49),happens(declare(40,7,carried),49),happens(declare(50,5,carried),49),happens(declare(50,6,carried),49),happens(declare(60,5,carried),49),happens(declare(60,7,carried),49),happens(declare(50,9,carried),49),happens(declare(20,9,carried),49),happens(declare(90,5,carried),49),happens(declare(40,3,carried),49),happens(declare(40,6,carried),49),happens(declare(50,5,carried),49),happens(declare(70,7,carried),49),happens(propose(20,2),50),happens(propose(90,4),50),happens(propose(20,4),50),happens(propose(60,7),50),happens(propose(70,9),50),happens(propose(20,8),50),happens(propose(20,9),50),happens(propose(30,6),50),happens(propose(60,3),50),happens(propose(40,4),50),happens(propose(80,1),50),happens(propose(30,9),50),happens(propose(7,9),51),happens(propose(81,4),51),happens(propose(2,3),51),happens(propose(10,2),51),happens(propose(70,1),51),happens(propose(39,2),51),happens(propose(41,10),51),happens(propose(53,9),51),happens(propose(26,8),51),happens(propose(14,2),51),happens(propose(92,3),51),happens(propose(87,8),51),happens(propose(27,1),51),happens(propose(61,5),51),happens(propose(49,7),51),happens(propose(68,4),51),happens(propose(15,1),51),happens(propose(75,1),51),happens(close_ballot(90,2),52),happens(second(20,5),53),happens(second(50,4),53),happens(second(50,6),53),happens(second(40,6),53),happens(second(60,6),53),happens(second(70,4),53),happens(second(60,7),53),happens(second(90,1),53),happens(second(60,10),53),happens(second(60,1),53),happens(second(20,1),53),happens(second(50,10),53),happens(second(50,2),53),happens(second(50,2),53),happens(second(20,1),53),happens(second(10,1),53),happens(second(90,1),53),happens(close_ballot(70,5),57),happens(close_ballot(70,9),57),happens(close_ballot(90,1),57),happens(close_ballot(0,10),57),happens(declare(60,2,not_carried),58),happens(declare(50,3,not_carried),58),happens(declare(0,10,not_carried),58),happens(declare(70,2,not_carried),58),happens(declare(80,8,not_carried),58),happens(declare(60,4,not_carried),58),happens(declare(40,3,not_carried),58),happens(declare(20,7,not_carried),58),happens(declare(40,4,not_carried),58),happens(declare(90,3,not_carried),58),happens(declare(50,10,not_carried),58),happens(declare(70,6,not_carried),58),happens(declare(30,7,not_carried),58),happens(declare(70,8,not_carried),58),happens(declare(70,7,not_carried),58),happens(declare(70,2,carried),59),happens(declare(80,7,carried),59),happens(declare(70,6,carried),59),happens(declare(0,4,carried),59),happens(declare(90,9,carried),59),happens(declare(0,6,carried),59),happens(declare(50,5,carried),59),happens(declare(70,7,carried),59),happens(declare(60,10,carried),59),happens(declare(60,8,carried),59),happens(declare(10,4,carried),59),happens(declare(90,3,carried),59),happens(declare(30,1,carried),59),happens(propose(80,3),60),happens(propose(40,7),60),happens(propose(60,2),60),happens(propose(30,6),60),happens(propose(70,9),60),happens(propose(90,4),60),happens(propose(60,7),60),happens(propose(50,5),60),happens(propose(10,10),60),happens(propose(30,1),60),happens(propose(20,4),60),happens(propose(70,5),60),happens(propose(19,3),61),happens(propose(10,2),61),happens(propose(87,5),61),happens(propose(79,4),61),happens(propose(47,7),61),happens(propose(59,4),61),happens(propose(9,8),61),happens(propose(51,4),61),happens(propose(98,8),61),happens(propose(54,7),61),happens(propose(51,5),61),happens(propose(70,2),61),happens(propose(36,2),61),happens(propose(75,10),61),happens(propose(72,1),61),happens(propose(60,6),61),happens(propose(6,3),61),happens(propose(47,4),61),happens(close_ballot(80,6),62),happens(second(70,5),63),happens(second(40,10),63),happens(second(30,1),63),happens(second(10,1),63),happens(second(20,4),63),happens(second(70,3),63),happens(second(50,2),63),happens(second(30,4),63),happens(second(90,3),63),happens(second(30,7),63),happens(second(20,6),63),happens(second(10,6),63),happens(second(50,8),63),happens(second(70,1),63),happens(second(50,4),63),happens(second(40,4),63),happens(second(20,7),63),happens(close_ballot(0,7),67),happens(close_ballot(0,4),67),happens(close_ballot(0,3),67),happens(close_ballot(30,8),67),happens(declare(0,2,not_carried),68),happens(declare(90,3,not_carried),68),happens(declare(50,8,not_carried),68),happens(declare(90,4,not_carried),68),happens(declare(20,8,not_carried),68),happens(declare(90,10,not_carried),68),happens(declare(30,6,not_carried),68),happens(declare(90,1,not_carried),68),happens(declare(40,7,not_carried),68),happens(declare(10,6,not_carried),68),happens(declare(80,1,not_carried),68),happens(declare(60,6,not_carried),68),happens(declare(50,2,not_carried),68),happens(declare(20,4,not_carried),68),happens(declare(10,9,not_carried),68),happens(declare(0,8,carried),69),happens(declare(40,6,carried),69),happens(declare(70,10,carried),69),happens(declare(10,9,carried),69),happens(declare(10,9,carried),69),happens(declare(80,7,carried),69),happens(declare(70,3,carried),69),happens(declare(20,6,carried),69),happens(declare(40,7,carried),69),happens(declare(60,8,carried),69),happens(declare(40,7,carried),69),happens(declare(70,3,carried),69),happens(declare(10,3,carried),69),happens(propose(10,10),70),happens(propose(10,8),70),happens(propose(20,8),70),happens(propose(40,3),70),happens(propose(70,4),70),happens(propose(70,8),70),happens(propose(70,10),70),happens(propose(30,9),70),happens(propose(10,7),70),happens(propose(60,9),70),happens(propose(20,8),70),happens(propose(40,4),70),happens(propose(2,3),71),happens(propose(48,5),71),happens(propose(69,8),71),happens(propose(1,1),71),happens(propose(29,8),71),happens(propose(34,1),71),happens(propose(25,8),71),happens(propose(53,7),71),happens(propose(61,10),71),happens(propose(93,5),71),happens(propose(51,5),71),happens(propose(1,7),71),happens(propose(78,8),71),happens(propose(13,5),71),happens(propose(26,10),71),happens(propose(6,7),71),happens(propose(73,2),71),happens(propose(98,9),71),happens(close_ballot(10,2),72),happens(second(50,5),73),happens(second(80,9),73),happens(second(30,6),73),happens(second(50,9),73),happens(second(50,3),73),happens(second(30,2),73),happens(second(30,7),73),happens(second(10,7),73),happens(second(50,2),73),happens(second(30,4),73),happens(second(50,9),73),happens(second(80,10),73),happens(second(30,3),73),happens(second(30,1),73),happens(second(50,3),73),happens(second(10,3),73),happens(second(70,6),73),happens(close_ballot(80,8),77),happens(close_ballot(90,7),77),happens(close_ballot(10,2),77),happens(close_ballot(70,9),77),happens(declare(0,1,not_carried),78),happens(declare(70,2,not_carried),78),happens(declare(40,1,not_carried),78),happens(declare(10,2,not_carried),78),happens(declare(50,9,not_carried),78),happens(declare(90,4,not_carried),78),happens(declare(60,2,not_carried),78),happens(declare(60,6,not_carried),78),happens(declare(70,7,not_carried),78),happens(declare(20,1,not_carried),78),happens(declare(40,7,not_carried),78),happens(declare(10,8,not_carried),78),happens(declare(80,8,not_carried),78),happens(declare(20,3,not_carried),78),happens(declare(20,9,not_carried),78),happens(declare(20,8,carried),79),happens(declare(0,3,carried),79),happens(declare(70,7,carried),79),happens(declare(10,8,carried),79),happens(declare(40,5,carried),79),happens(declare(80,7,carried),79),happens(declare(40,10,carried),79),happens(declare(80,3,carried),79),happens(declare(0,1,carried),79),happens(declare(20,1,carried),79),happens(declare(40,9,carried),79),happens(declare(90,8,carried),79),happens(declare(30,2,carried),79),happens(propose(30,10),80),happens(propose(90,6),80),happens(propose(30,7),80),happens(propose(70,2),80),happens(propose(20,5),80),happens(propose(30,4),80),happens(propose(50,10),80),happens(propose(70,8),80),happens(propose(30,1),80),happens(propose(20,8),80),happens(propose(60,2),80),happens(propose(60,8),80),happens(propose(82,2),81),happens(propose(18,8),81),happens(propose(57,8),81),happens(propose(83,9),81),happens(propose(90,9),81),happens(propose(80,3),81),happens(propose(70,3),81),happens(propose(67,9),81),happens(propose(29,10),81),happens(propose(98,3),81),happens(propose(37,6),81),happens(propose(16,1),81),happens(propose(43,1),81),happens(propose(80,3),81),happens(propose(27,5),81),happens(propose(15,9),81),happens(propose(61,10),81),happens(propose(35,7),81),happens(close_ballot(60,9),82),happens(second(10,4),83),happens(second(80,10),83),happens(second(80,10),83),happens(second(30,7),83),happens(second(70,6),83),happens(second(70,10),83),happens(second(90,7),83),happens(second(50,9),83),happens(second(80,5),83),happens(second(20,5),83),happens(second(30,8),83),happens(second(30,1),83),happens(second(30,10),83),happens(second(40,7),83),happens(second(50,4),83),happens(second(60,4),83),happens(second(70,2),83),happens(close_ballot(70,7),87),happens(close_ballot(10,3),87),happens(close_ballot(30,9),87),happens(close_ballot(40,3),87),happens(declare(80,3,not_carried),88),happens(declare(0,4,not_carried),88),happens(declare(50,4,not_carried),88),happens(declare(80,3,not_carried),88),happens(declare(40,8,not_carried),88),happens(declare(30,3,not_carried),88),happens(declare(0,9,not_carried),88),happens(declare(40,10,not_carried),88),happens(declare(60,9,not_carried),88),happens(declare(60,5,not_carried),88),happens(declare(20,8,not_carried),88),happens(declare(90,2,not_carried),88),happens(declare(10,2,not_carried),88),happens(declare(80,10,not_carried),88),happens(declare(20,10,not_carried),88),happens(declare(40,2,carried),89),happens(declare(90,10,carried),89),happens(declare(20,8,carried),89),happens(declare(50,4,carried),89),happens(declare(50,4,carried),89),happens(declare(80,1,carried),89),happens(declare(40,7,carried),89),happens(declare(10,1,carried),89),happens(declare(20,4,carried),89),happens(declare(70,5,carried),89),happens(declare(90,1,carried),89),happens(declare(20,2,carried),89),happens(declare(60,10,carried),89),happens(propose(80,4),90),happens(propose(80,7),90),happens(propose(70,7),90),happens(propose(40,2),90),happens(propose(60,7),90),happens(propose(50,3),90),happens(propose(60,4),90),happens(propose(70,7),90),happens(propose(30,1),90),happens(propose(90,8),90),happens(propose(70,10),90),happens(propose(30,1),90),happens(propose(30,2),91),happens(propose(75,7),91),happens(propose(8,4),91),happens(propose(51,9),91),happens(propose(2,8),91),happens(propose(73,1),91),happens(propose(84,1),91),happens(propose(48,2),91),happens(propose(17,8),91),happens(propose(10,2),91),happens(propose(18,9),91),happens(propose(21,7),91),happens(propose(38,3),91),happens(propose(91,3),91),happens(propose(14,8),91),happens(propose(56,7),91),happens(propose(91,1),91),happens(propose(62,9),91),happens(close_ballot(70,9),92),happens(second(10,10),93),happens(second(20,10),93),happens(second(20,7),93),happens(second(20,1),93),happens(second(90,8),93),happens(second(10,4),93),happens(second(50,3),93),happens(second(60,10),93),happens(second(20,1),93),happens(second(20,10),93),happens(second(80,1),93),happens(second(10,10),93),happens(second(70,2),93),happens(second(80,10),93),happens(second(30,7),93),happens(second(80,4),93),happens(second(30,6),93),happens(close_ballot(10,2),97),happens(close_ballot(10,1),97),happens(close_ballot(0,1),97),happens(close_ballot(50,9),97),happens(declare(60,6,not_carried),98),happens(declare(0,1,not_carried),98),happens(declare(20,7,not_carried),98),happens(declare(70,5,not_carried),98),happens(declare(70,8,not_carried),98),happens(declare(80,6,not_carried),98),happens(declare(20,4,not_carried),98),happens(declare(50,3,not_carried),98),happens(declare(20,1,not_carried),98),happens(declare(90,4,not_carried),98),happens(declare(60,1,not_carried),98),happens(declare(50,10,not_carried),98),happens(declare(70,5,not_carried),98),happens(declare(0,2,not_carried),98),happens(declare(40,10,not_carried),98),happens(declare(30,8,carried),99),happens(declare(0,10,carried),99),happens(declare(90,10,carried),99),happens(declare(60,3,carried),99),happens(declare(30,10,carried),99),happens(declare(10,7,carried),99),happens(declare(30,8,carried),99),happens(declare(70,8,carried),99),happens(declare(80,3,carried),99),happens(declare(40,2,carried),99),happens(declare(0,10,carried),99),happens(declare(20,3,carried),99),happens(declare(70,5,carried),99)]),
	status(MVIs).


initiates(propose(_,M), motionStatus(M, proposed),T):-
	holds_at(motionStatus(M, null),T).

terminates(propose(_,M),motionStatus(M, null),T).

initiates(second(_,M),motionStatus(M, voting),T):-
	holds_at(motionStatus(M, proposed),T).

terminates(second(_,M),motionStatus(M, proposed),T).

initiates(close_ballot(_,M), motionStatus(M, voted),T):-
	holds_at(motionStatus(M, voting),T).

terminates(close_ballot(_,M),motionStatus(M, voting),T).

initiates(declare(_,M,_),motionStatus(M, null),T):-
	holds_at(motionStatus(M,voted),T).

terminates(declare(_,M,_),motionStatus(M, voted),T).

initially(motionStatus(1, null)).
initially(motionStatus(2, null)).
initially(motionStatus(3, null)).
initially(motionStatus(4, null)).
initially(motionStatus(5, null)).
initially(motionStatus(6, null)).
initially(motionStatus(7, null)).
initially(motionStatus(8, null)).
initially(motionStatus(9, null)).
initially(motionStatus(10, null)).

:-unknown(_,fail).

lt(A,B):-gt(B,A).
le(A,B):-ge(B,A).

gt(inf,B):- B\==inf,!.
gt(_,inf):-!,fail.
gt(A,B):- A>B.

ge(A,A):-!.
ge(A,B):-gt(A,B).

holds_at(F, T):-
	holds_from(F, T, _).

holds_from(F, T, T1):-
	mholds_for(F, [T1, T2]),
	gt(T, T1),
	le(T, T2).

initiates(startf, F, T):-
	initially(F).

declip(F,T):-
	happens(E,T),
	initiates(E, F, T),
	\+ holds_at(F, T).

clip(F,T):-
	happens(E,T),
	terminates(E, F, T),
	holds_at(F, T).


start:-
	write("ENGINE STARTED"),nl,
	set_classpath([""]),
	java_object("TermRBTMap", [], kbMap),
	java_object("TermRBTMap", [], mviMap),
	register(kbMap),
	register(mviMap),
	update([happens(startf,-1)]).

update(ExtTrace):-
	%write("UPDATING EVENTS"),nl,
	java_object("TermRBTMap", [], traceMap),
	%register(traceMap),
	events_to_map(traceMap, ExtTrace),
	traceMap <- futureTrace(-2) returns Trace,
	text_term(Trace,T), nl,
	%unregister(traceMap),
	update_events(T).

events_to_map(M,[]).
events_to_map(M,[H|T]):-
	H = happens(_,T0),
	M <- putValue(T0,H),
	events_to_map(M,T).
	
mvis_to_map(M,[]).
mvis_to_map(M,[H|T]):-
	H = mholds_for(F,[Ts,Te]),
	M <- putValue(Ts,H),
	mvis_to_map(M,T).

update_events([]).
update_events([H|T]):-
	update_events(H),
	update_events(T).

%avoid event duplication
update_events([happens(E,T)|Events]):-
	happens(E,T),!,
	update_events([Events]).

update_events([happens(E,T)|Events]):-
	\+ happens(E,T),
	kbMap <- futureTrace(T) returns FTrace,
	text_term(FTrace,FT), nl,
	roll_back(T,FT),
	calculate_effects([[happens(E,T)|Events]|FT]).

roll_back(T,FT):-
	remove_events(FT),
	remove_future_MVIs(T),
	open_current_MVIs(T).


% bisogna ritrarre soltanto eventi che si sono già asseriti, altrimenti questa clausola fallisce
% inoltre H deve essere un singolo evento, non una lista di eventi, infatti nella vecchia rec.pl
% future_trace ritorna una lista di tutti gli eventi che accadono dopo un certo timepoint,
% non una lista di liste
remove_events([]).
remove_events([H|T]):-
	remove_events(H),
	remove_events(T).

remove_events([H|Trace]):-
	retract(H),
	remove_events(Trace).

future_MVI(mholds_for(F,[Ts,Te]),Tref):-
	mholds_for(F,[Ts,Te]),
	gt(Ts,Tref).

%swap this with an indexer call
remove_future_MVIs(T):-
        %remove from the indexer all mvis which start past T 
	my_setof(MVI,future_MVI(MVI,T),MVIs),
	remove_MVIs(MVIs).

remove_MVIs([]).
remove_MVIs([MVI|MVIs]):-
	retract(MVI),
	remove_MVIs(MVIs).

current_MVI(mholds_for(F,[Ts,Te]),Tref):-
	mholds_for(F,[Ts,Te]),
	gt(Tref,Ts),
	le(Tref,Te).

%swap this with an indexer call
open_current_MVIs(T):-
        %open all the mvis in the indexer that are holding at T
	my_setof(MVI,current_MVI(MVI,T),MVIs),
	open_MVIs(MVIs).

open_MVIs([]).
open_MVIs([mholds_for(F,[Ts,Te])|MVIs]):-
	retract(mholds_for(F,[Ts,Te])),
	assert(mholds_for(F,[Ts,inf])),
	open_MVIs(MVIs).



calculate_effects([]).
calculate_effects([H|T]):-
	calculate_effects_events(H),
	calculate_effects(T).

calculate_effects_events([happens(E,T)|Events]):-
	assert_all([happens(E,T)|Events]),
	events_to_map(kbMap,[happens(E,T)|Events]),
	%keep this setof
	my_setof(F, clip(F,T),S),
	close_mvis(S,T),
	%keep this setof
	my_setof(F, declip(F,T),S2),
	open_mvis(S2,T).

my_setof(A,B,C):-
	setof(A,B,C),!.
my_setof(_,_,[]).

close_mvis([],_).
close_mvis([F|Fs],T):-
	close_mvi(F,T),
	close_mvis(Fs,T).

close_mvi(F,T):-
	holds_from(F,T,T1),
	%update the mvi in the index
	retract(mholds_for(F,[T1,inf])),
	assert(mholds_for(F,[T1,T])).

open_mvis([],_).
open_mvis([F|Fs],T):-
	open_mvi(F,T),
	open_mvis(Fs,T).

open_mvi(F,T):-
        %insert mvi to the index
	assert(mholds_for(F,[T,inf])).


status(MVIs):-
        %query the index
	findall(mholds_for(F,[T1,T2]),mholds_for(F,[T1,T2]),MVIs).

reset:-
	retractall(happens(_,_)),
	retractall(mholds_for(_,_)),
	unregister(kbMap),
	unregister(mviMap),
	write("ENGINE RESET").

assert_all([]).
assert_all([H|T]):-
	assert(H),
	assert_all(T).




write_ct:-
	class('java.lang.System') <- currentTimeInMillis returns M,
	write(current_time(M)).
