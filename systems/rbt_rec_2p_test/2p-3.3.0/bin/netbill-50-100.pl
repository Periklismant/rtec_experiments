test:-
	update([happens(presentQuote(30,11,book),1),happens(presentQuote(20,25,book),1),happens(presentQuote(30,16,book),1),happens(presentQuote(0,23,book),1),happens(presentQuote(0,47,book),1),happens(presentQuote(0,28,book),1),happens(presentQuote(30,4,book),1),happens(presentQuote(40,4,book),1),happens(presentQuote(20,14,book),1),happens(presentQuote(40,35,book),1),happens(presentQuote(40,13,book),1),happens(presentQuote(30,17,book),1),happens(presentQuote(0,32,book),1),happens(presentQuote(10,16,book),1),happens(presentQuote(40,41,book),1),happens(presentQuote(40,28,book),1),happens(presentQuote(20,5,book),1),happens(presentQuote(0,8,book),1),happens(presentQuote(40,34,book),1),happens(presentQuote(0,38,book),1),happens(presentQuote(0,5,book),1),happens(presentQuote(30,32,book),1),happens(presentQuote(30,16,book),1),happens(presentQuote(0,2,book),1),happens(presentQuote(20,20,book),1),happens(presentQuote(0,27,book),1),happens(presentQuote(10,6,book),1),happens(presentQuote(9,16,book),1),happens(presentQuote(33,4,book),1),happens(acceptQuote(40,47,book),6),happens(acceptQuote(10,41,book),6),happens(acceptQuote(40,16,book),6),happens(acceptQuote(10,10,book),6),happens(acceptQuote(10,14,book),6),happens(acceptQuote(20,32,book),6),happens(acceptQuote(40,29,book),6),happens(acceptQuote(40,23,book),6),happens(acceptQuote(30,17,book),6),happens(acceptQuote(30,19,book),6),happens(acceptQuote(10,8,book),6),happens(acceptQuote(0,23,book),6),happens(acceptQuote(40,49,book),6),happens(acceptQuote(30,17,book),6),happens(acceptQuote(10,34,book),6),happens(acceptQuote(0,14,book),6),happens(acceptQuote(10,10,book),6),happens(acceptQuote(30,16,book),6),happens(acceptQuote(0,4,book),6),happens(acceptQuote(40,22,book),6),happens(acceptQuote(40,17,book),6),happens(acceptQuote(20,37,book),6),happens(acceptQuote(0,13,book),6),happens(acceptQuote(10,34,book),6),happens(acceptQuote(0,31,book),6),happens(acceptQuote(40,31,book),6),happens(acceptQuote(30,49,book),6),happens(acceptQuote(10,22,book),6),happens(acceptQuote(0,41,book),6),happens(acceptQuote(20,23,book),6),happens(acceptQuote(10,31,book),6),happens(acceptQuote(0,38,book),6),happens(acceptQuote(30,28,book),6),happens(acceptQuote(0,34,book),6),happens(acceptQuote(20,29,book),6),happens(acceptQuote(0,40,book),6),happens(acceptQuote(20,14,book),6),happens(acceptQuote(20,11,book),6),happens(acceptQuote(0,16,book),6),happens(acceptQuote(10,44,book),6),happens(acceptQuote(0,19,book),6),happens(acceptQuote(20,40,book),6),happens(acceptQuote(10,38,book),6),happens(acceptQuote(0,34,book),6),happens(acceptQuote(0,8,book),6),happens(acceptQuote(30,19,book),6),happens(acceptQuote(0,11,book),6),happens(acceptQuote(20,37,book),6),happens(acceptQuote(10,47,book),6),happens(acceptQuote(10,17,book),6),happens(acceptQuote(10,10,book),6),happens(acceptQuote(10,32,book),6),happens(acceptQuote(30,7,book),6),happens(acceptQuote(10,32,book),6),happens(acceptQuote(20,35,book),6),happens(acceptQuote(40,8,book),6),happens(acceptQuote(10,38,book),6),happens(acceptQuote(0,26,book),6),happens(acceptQuote(0,41,book),6),happens(acceptQuote(10,4,book),6),happens(acceptQuote(20,44,book),6),happens(acceptQuote(10,46,book),6),happens(acceptQuote(20,8,book),6),happens(acceptQuote(10,38,book),6),happens(acceptQuote(20,20,book),6),happens(acceptQuote(40,19,book),6),happens(acceptQuote(40,12,book),6),happens(acceptQuote(0,3,book),6),happens(acceptQuote(0,42,book),6),happens(acceptQuote(30,36,book),6),happens(acceptQuote(10,12,book),6),happens(presentQuote(10,10,book),11),happens(presentQuote(40,47,book),11),happens(presentQuote(40,23,book),11),happens(presentQuote(20,34,book),11),happens(presentQuote(30,28,book),11),happens(presentQuote(0,49,book),11),happens(presentQuote(40,29,book),11),happens(presentQuote(10,22,book),11),happens(presentQuote(20,2,book),11),happens(presentQuote(10,7,book),11),happens(presentQuote(40,37,book),11),happens(presentQuote(20,14,book),11),happens(presentQuote(20,29,book),11),happens(presentQuote(10,17,book),11),happens(presentQuote(20,14,book),11),happens(presentQuote(20,4,book),11),happens(presentQuote(0,46,book),11),happens(presentQuote(30,28,book),11),happens(presentQuote(20,25,book),11),happens(presentQuote(10,25,book),11),happens(presentQuote(10,28,book),11),happens(presentQuote(20,37,book),11),happens(presentQuote(0,2,book),11),happens(presentQuote(40,46,book),11),happens(presentQuote(40,35,book),11),happens(presentQuote(20,9,book),11),happens(presentQuote(10,9,book),11),happens(presentQuote(18,20,book),11),happens(presentQuote(24,23,book),11),happens(acceptQuote(30,7,book),16),happens(acceptQuote(20,43,book),16),happens(acceptQuote(20,35,book),16),happens(acceptQuote(20,26,book),16),happens(acceptQuote(0,20,book),16),happens(acceptQuote(40,44,book),16),happens(acceptQuote(10,11,book),16),happens(acceptQuote(0,20,book),16),happens(acceptQuote(20,37,book),16),happens(acceptQuote(20,40,book),16),happens(acceptQuote(10,35,book),16),happens(acceptQuote(10,43,book),16),happens(acceptQuote(40,34,book),16),happens(acceptQuote(30,26,book),16),happens(acceptQuote(20,35,book),16),happens(acceptQuote(0,19,book),16),happens(acceptQuote(20,11,book),16),happens(acceptQuote(0,25,book),16),happens(acceptQuote(40,17,book),16),happens(acceptQuote(10,43,book),16),happens(acceptQuote(40,8,book),16),happens(acceptQuote(30,5,book),16),happens(acceptQuote(0,29,book),16),happens(acceptQuote(10,44,book),16),happens(acceptQuote(40,41,book),16),happens(acceptQuote(40,23,book),16),happens(acceptQuote(30,35,book),16),happens(acceptQuote(20,46,book),16),happens(acceptQuote(30,13,book),16),happens(acceptQuote(20,29,book),16),happens(acceptQuote(20,44,book),16),happens(acceptQuote(10,29,book),16),happens(acceptQuote(40,22,book),16),happens(acceptQuote(40,40,book),16),happens(acceptQuote(30,16,book),16),happens(acceptQuote(0,49,book),16),happens(acceptQuote(40,8,book),16),happens(acceptQuote(0,22,book),16),happens(acceptQuote(10,35,book),16),happens(acceptQuote(10,44,book),16),happens(acceptQuote(20,5,book),16),happens(acceptQuote(20,8,book),16),happens(acceptQuote(30,8,book),16),happens(acceptQuote(20,16,book),16),happens(acceptQuote(10,14,book),16),happens(acceptQuote(0,10,book),16),happens(acceptQuote(20,1,book),16),happens(acceptQuote(30,19,book),16),happens(acceptQuote(10,17,book),16),happens(acceptQuote(20,13,book),16),happens(acceptQuote(40,13,book),16),happens(acceptQuote(0,13,book),16),happens(acceptQuote(0,13,book),16),happens(acceptQuote(0,5,book),16),happens(acceptQuote(10,10,book),16),happens(acceptQuote(0,44,book),16),happens(acceptQuote(40,10,book),16),happens(acceptQuote(40,5,book),16),happens(acceptQuote(20,2,book),16),happens(acceptQuote(30,34,book),16),happens(acceptQuote(20,8,book),16),happens(acceptQuote(0,4,book),16),happens(acceptQuote(40,14,book),16),happens(acceptQuote(20,22,book),16),happens(acceptQuote(0,32,book),16),happens(acceptQuote(30,44,book),16),happens(acceptQuote(20,42,book),16),happens(acceptQuote(20,15,book),16),happens(acceptQuote(30,21,book),16),happens(acceptQuote(10,21,book),16),happens(acceptQuote(40,21,book),16),happens(presentQuote(40,14,book),21),happens(presentQuote(40,4,book),21),happens(presentQuote(30,32,book),21),happens(presentQuote(40,10,book),21),happens(presentQuote(0,35,book),21),happens(presentQuote(30,41,book),21),happens(presentQuote(40,44,book),21),happens(presentQuote(10,34,book),21),happens(presentQuote(30,25,book),21),happens(presentQuote(20,43,book),21),happens(presentQuote(30,11,book),21),happens(presentQuote(20,7,book),21),happens(presentQuote(10,47,book),21),happens(presentQuote(30,14,book),21),happens(presentQuote(40,47,book),21),happens(presentQuote(0,4,book),21),happens(presentQuote(40,10,book),21),happens(presentQuote(0,29,book),21),happens(presentQuote(0,17,book),21),happens(presentQuote(30,35,book),21),happens(presentQuote(20,10,book),21),happens(presentQuote(40,38,book),21),happens(presentQuote(30,19,book),21),happens(presentQuote(40,26,book),21),happens(presentQuote(30,35,book),21),happens(presentQuote(30,33,book),21),happens(presentQuote(0,36,book),21),happens(presentQuote(24,49,book),21),happens(presentQuote(27,29,book),21),happens(acceptQuote(20,46,book),26),happens(acceptQuote(0,8,book),26),happens(acceptQuote(10,23,book),26),happens(acceptQuote(30,10,book),26),happens(acceptQuote(20,20,book),26),happens(acceptQuote(30,19,book),26),happens(acceptQuote(40,41,book),26),happens(acceptQuote(40,4,book),26),happens(acceptQuote(20,2,book),26),happens(acceptQuote(20,8,book),26),happens(acceptQuote(10,49,book),26),happens(acceptQuote(30,43,book),26),happens(acceptQuote(0,38,book),26),happens(acceptQuote(0,7,book),26),happens(acceptQuote(40,5,book),26),happens(acceptQuote(10,5,book),26),happens(acceptQuote(0,10,book),26),happens(acceptQuote(0,40,book),26),happens(acceptQuote(0,38,book),26),happens(acceptQuote(0,10,book),26),happens(acceptQuote(0,19,book),26),happens(acceptQuote(10,22,book),26),happens(acceptQuote(0,38,book),26),happens(acceptQuote(0,20,book),26),happens(acceptQuote(0,19,book),26),happens(acceptQuote(20,19,book),26),happens(acceptQuote(20,20,book),26),happens(acceptQuote(10,10,book),26),happens(acceptQuote(40,20,book),26),happens(acceptQuote(30,44,book),26),happens(acceptQuote(0,47,book),26),happens(acceptQuote(10,35,book),26),happens(acceptQuote(30,37,book),26),happens(acceptQuote(20,5,book),26),happens(acceptQuote(40,17,book),26),happens(acceptQuote(10,17,book),26),happens(acceptQuote(0,17,book),26),happens(acceptQuote(40,32,book),26),happens(acceptQuote(0,4,book),26),happens(acceptQuote(30,8,book),26),happens(acceptQuote(10,20,book),26),happens(acceptQuote(20,43,book),26),happens(acceptQuote(10,38,book),26),happens(acceptQuote(20,32,book),26),happens(acceptQuote(20,47,book),26),happens(acceptQuote(10,14,book),26),happens(acceptQuote(40,16,book),26),happens(acceptQuote(30,49,book),26),happens(acceptQuote(10,20,book),26),happens(acceptQuote(40,16,book),26),happens(acceptQuote(30,20,book),26),happens(acceptQuote(10,49,book),26),happens(acceptQuote(0,4,book),26),happens(acceptQuote(40,20,book),26),happens(acceptQuote(20,49,book),26),happens(acceptQuote(0,8,book),26),happens(acceptQuote(10,49,book),26),happens(acceptQuote(40,26,book),26),happens(acceptQuote(10,13,book),26),happens(acceptQuote(0,34,book),26),happens(acceptQuote(20,7,book),26),happens(acceptQuote(20,43,book),26),happens(acceptQuote(20,17,book),26),happens(acceptQuote(10,20,book),26),happens(acceptQuote(40,37,book),26),happens(acceptQuote(20,35,book),26),happens(acceptQuote(20,12,book),26),happens(acceptQuote(20,48,book),26),happens(acceptQuote(20,27,book),26),happens(acceptQuote(0,9,book),26),happens(acceptQuote(0,3,book),26),happens(presentQuote(30,44,book),31),happens(presentQuote(20,34,book),31),happens(presentQuote(40,8,book),31),happens(presentQuote(20,37,book),31),happens(presentQuote(10,29,book),31),happens(presentQuote(20,16,book),31),happens(presentQuote(40,17,book),31),happens(presentQuote(40,26,book),31),happens(presentQuote(20,1,book),31),happens(presentQuote(20,22,book),31),happens(presentQuote(20,17,book),31),happens(presentQuote(10,20,book),31),happens(presentQuote(20,22,book),31),happens(presentQuote(10,13,book),31),happens(presentQuote(20,8,book),31),happens(presentQuote(10,35,book),31),happens(presentQuote(30,40,book),31),happens(presentQuote(40,26,book),31),happens(presentQuote(0,14,book),31),happens(presentQuote(20,7,book),31),happens(presentQuote(40,47,book),31),happens(presentQuote(0,43,book),31),happens(presentQuote(30,28,book),31),happens(presentQuote(40,47,book),31),happens(presentQuote(30,43,book),31),happens(presentQuote(0,21,book),31),happens(presentQuote(0,48,book),31),happens(presentQuote(9,44,book),31),happens(presentQuote(33,16,book),31),happens(acceptQuote(20,5,book),36),happens(acceptQuote(30,32,book),36),happens(acceptQuote(30,35,book),36),happens(acceptQuote(20,10,book),36),happens(acceptQuote(40,47,book),36),happens(acceptQuote(0,17,book),36),happens(acceptQuote(0,26,book),36),happens(acceptQuote(30,29,book),36),happens(acceptQuote(30,46,book),36),happens(acceptQuote(0,34,book),36),happens(acceptQuote(20,49,book),36),happens(acceptQuote(20,25,book),36),happens(acceptQuote(40,28,book),36),happens(acceptQuote(10,14,book),36),happens(acceptQuote(0,14,book),36),happens(acceptQuote(30,43,book),36),happens(acceptQuote(20,22,book),36),happens(acceptQuote(10,35,book),36),happens(acceptQuote(10,37,book),36),happens(acceptQuote(0,44,book),36),happens(acceptQuote(10,43,book),36),happens(acceptQuote(0,2,book),36),happens(acceptQuote(40,31,book),36),happens(acceptQuote(40,41,book),36),happens(acceptQuote(20,32,book),36),happens(acceptQuote(10,22,book),36),happens(acceptQuote(40,5,book),36),happens(acceptQuote(30,44,book),36),happens(acceptQuote(0,25,book),36),happens(acceptQuote(20,4,book),36),happens(acceptQuote(40,41,book),36),happens(acceptQuote(20,44,book),36),happens(acceptQuote(10,34,book),36),happens(acceptQuote(20,17,book),36),happens(acceptQuote(0,34,book),36),happens(acceptQuote(0,17,book),36),happens(acceptQuote(20,22,book),36),happens(acceptQuote(0,43,book),36),happens(acceptQuote(30,31,book),36),happens(acceptQuote(10,20,book),36),happens(acceptQuote(10,5,book),36),happens(acceptQuote(10,34,book),36),happens(acceptQuote(40,11,book),36),happens(acceptQuote(10,35,book),36),happens(acceptQuote(20,41,book),36),happens(acceptQuote(40,28,book),36),happens(acceptQuote(40,5,book),36),happens(acceptQuote(0,28,book),36),happens(acceptQuote(10,41,book),36),happens(acceptQuote(10,34,book),36),happens(acceptQuote(0,14,book),36),happens(acceptQuote(20,2,book),36),happens(acceptQuote(10,19,book),36),happens(acceptQuote(0,8,book),36),happens(acceptQuote(20,35,book),36),happens(acceptQuote(40,38,book),36),happens(acceptQuote(10,47,book),36),happens(acceptQuote(10,1,book),36),happens(acceptQuote(30,2,book),36),happens(acceptQuote(20,29,book),36),happens(acceptQuote(40,20,book),36),happens(acceptQuote(20,23,book),36),happens(acceptQuote(40,11,book),36),happens(acceptQuote(0,17,book),36),happens(acceptQuote(0,46,book),36),happens(acceptQuote(0,40,book),36),happens(acceptQuote(20,24,book),36),happens(acceptQuote(40,39,book),36),happens(acceptQuote(0,36,book),36),happens(acceptQuote(40,39,book),36),happens(acceptQuote(30,36,book),36),happens(presentQuote(20,35,book),41),happens(presentQuote(40,41,book),41),happens(presentQuote(10,8,book),41),happens(presentQuote(10,38,book),41),happens(presentQuote(0,8,book),41),happens(presentQuote(10,46,book),41),happens(presentQuote(10,31,book),41),happens(presentQuote(40,25,book),41),happens(presentQuote(20,41,book),41),happens(presentQuote(0,31,book),41),happens(presentQuote(40,4,book),41),happens(presentQuote(40,41,book),41),happens(presentQuote(10,2,book),41),happens(presentQuote(10,44,book),41),happens(presentQuote(40,43,book),41),happens(presentQuote(20,26,book),41),happens(presentQuote(0,38,book),41),happens(presentQuote(40,10,book),41),happens(presentQuote(20,41,book),41),happens(presentQuote(40,35,book),41),happens(presentQuote(20,8,book),41),happens(presentQuote(40,1,book),41),happens(presentQuote(40,7,book),41),happens(presentQuote(10,1,book),41),happens(presentQuote(40,14,book),41),happens(presentQuote(0,36,book),41),happens(presentQuote(20,39,book),41),happens(presentQuote(12,23,book),41),happens(presentQuote(45,37,book),41),happens(acceptQuote(20,49,book),46),happens(acceptQuote(0,2,book),46),happens(acceptQuote(10,10,book),46),happens(acceptQuote(10,43,book),46),happens(acceptQuote(20,11,book),46),happens(acceptQuote(0,46,book),46),happens(acceptQuote(10,37,book),46),happens(acceptQuote(40,14,book),46),happens(acceptQuote(30,11,book),46),happens(acceptQuote(20,37,book),46),happens(acceptQuote(40,22,book),46),happens(acceptQuote(40,32,book),46),happens(acceptQuote(10,5,book),46),happens(acceptQuote(40,32,book),46),happens(acceptQuote(20,46,book),46),happens(acceptQuote(10,43,book),46),happens(acceptQuote(40,32,book),46),happens(acceptQuote(0,47,book),46),happens(acceptQuote(10,44,book),46),happens(acceptQuote(20,10,book),46),happens(acceptQuote(30,7,book),46),happens(acceptQuote(0,11,book),46),happens(acceptQuote(30,28,book),46),happens(acceptQuote(40,17,book),46),happens(acceptQuote(40,1,book),46),happens(acceptQuote(30,43,book),46),happens(acceptQuote(0,25,book),46),happens(acceptQuote(30,41,book),46),happens(acceptQuote(40,13,book),46),happens(acceptQuote(0,47,book),46),happens(acceptQuote(30,10,book),46),happens(acceptQuote(10,7,book),46),happens(acceptQuote(0,40,book),46),happens(acceptQuote(40,14,book),46),happens(acceptQuote(20,7,book),46),happens(acceptQuote(30,47,book),46),happens(acceptQuote(0,35,book),46),happens(acceptQuote(30,1,book),46),happens(acceptQuote(20,41,book),46),happens(acceptQuote(30,28,book),46),happens(acceptQuote(10,31,book),46),happens(acceptQuote(20,38,book),46),happens(acceptQuote(30,37,book),46),happens(acceptQuote(30,13,book),46),happens(acceptQuote(20,1,book),46),happens(acceptQuote(0,47,book),46),happens(acceptQuote(40,47,book),46),happens(acceptQuote(10,22,book),46),happens(acceptQuote(10,41,book),46),happens(acceptQuote(0,32,book),46),happens(acceptQuote(30,32,book),46),happens(acceptQuote(0,38,book),46),happens(acceptQuote(10,11,book),46),happens(acceptQuote(20,34,book),46),happens(acceptQuote(40,41,book),46),happens(acceptQuote(0,10,book),46),happens(acceptQuote(0,29,book),46),happens(acceptQuote(0,26,book),46),happens(acceptQuote(30,31,book),46),happens(acceptQuote(0,7,book),46),happens(acceptQuote(10,8,book),46),happens(acceptQuote(20,46,book),46),happens(acceptQuote(10,49,book),46),happens(acceptQuote(20,41,book),46),happens(acceptQuote(20,28,book),46),happens(acceptQuote(30,5,book),46),happens(acceptQuote(0,27,book),46),happens(acceptQuote(30,48,book),46),happens(acceptQuote(0,36,book),46),happens(acceptQuote(20,27,book),46),happens(acceptQuote(0,27,book),46),happens(presentQuote(40,37,book),51),happens(presentQuote(20,16,book),51),happens(presentQuote(30,22,book),51),happens(presentQuote(40,26,book),51),happens(presentQuote(0,44,book),51),happens(presentQuote(10,8,book),51),happens(presentQuote(30,37,book),51),happens(presentQuote(40,8,book),51),happens(presentQuote(20,34,book),51),happens(presentQuote(40,7,book),51),happens(presentQuote(0,49,book),51),happens(presentQuote(20,49,book),51),happens(presentQuote(40,19,book),51),happens(presentQuote(40,4,book),51),happens(presentQuote(30,14,book),51),happens(presentQuote(20,38,book),51),happens(presentQuote(10,43,book),51),happens(presentQuote(0,10,book),51),happens(presentQuote(10,34,book),51),happens(presentQuote(10,22,book),51),happens(presentQuote(40,19,book),51),happens(presentQuote(10,25,book),51),happens(presentQuote(20,47,book),51),happens(presentQuote(10,16,book),51),happens(presentQuote(10,14,book),51),happens(presentQuote(20,9,book),51),happens(presentQuote(10,45,book),51),happens(presentQuote(3,34,book),51),happens(presentQuote(48,13,book),51),happens(acceptQuote(0,8,book),56),happens(acceptQuote(20,44,book),56),happens(acceptQuote(0,25,book),56),happens(acceptQuote(30,38,book),56),happens(acceptQuote(0,23,book),56),happens(acceptQuote(0,23,book),56),happens(acceptQuote(20,47,book),56),happens(acceptQuote(10,37,book),56),happens(acceptQuote(20,35,book),56),happens(acceptQuote(10,35,book),56),happens(acceptQuote(10,46,book),56),happens(acceptQuote(0,7,book),56),happens(acceptQuote(0,43,book),56),happens(acceptQuote(20,8,book),56),happens(acceptQuote(30,4,book),56),happens(acceptQuote(10,19,book),56),happens(acceptQuote(20,28,book),56),happens(acceptQuote(40,10,book),56),happens(acceptQuote(10,37,book),56),happens(acceptQuote(30,32,book),56),happens(acceptQuote(30,47,book),56),happens(acceptQuote(40,34,book),56),happens(acceptQuote(20,22,book),56),happens(acceptQuote(20,14,book),56),happens(acceptQuote(40,43,book),56),happens(acceptQuote(40,46,book),56),happens(acceptQuote(40,29,book),56),happens(acceptQuote(30,26,book),56),happens(acceptQuote(10,47,book),56),happens(acceptQuote(40,29,book),56),happens(acceptQuote(40,34,book),56),happens(acceptQuote(20,19,book),56),happens(acceptQuote(10,20,book),56),happens(acceptQuote(40,1,book),56),happens(acceptQuote(10,41,book),56),happens(acceptQuote(20,37,book),56),happens(acceptQuote(40,37,book),56),happens(acceptQuote(40,13,book),56),happens(acceptQuote(30,41,book),56),happens(acceptQuote(20,29,book),56),happens(acceptQuote(0,41,book),56),happens(acceptQuote(0,38,book),56),happens(acceptQuote(30,4,book),56),happens(acceptQuote(0,25,book),56),happens(acceptQuote(20,29,book),56),happens(acceptQuote(10,43,book),56),happens(acceptQuote(20,31,book),56),happens(acceptQuote(0,46,book),56),happens(acceptQuote(0,11,book),56),happens(acceptQuote(30,4,book),56),happens(acceptQuote(30,10,book),56),happens(acceptQuote(40,32,book),56),happens(acceptQuote(30,41,book),56),happens(acceptQuote(0,25,book),56),happens(acceptQuote(10,35,book),56),happens(acceptQuote(20,16,book),56),happens(acceptQuote(0,47,book),56),happens(acceptQuote(10,1,book),56),happens(acceptQuote(0,43,book),56),happens(acceptQuote(20,28,book),56),happens(acceptQuote(10,8,book),56),happens(acceptQuote(0,32,book),56),happens(acceptQuote(40,28,book),56),happens(acceptQuote(30,34,book),56),happens(acceptQuote(40,14,book),56),happens(acceptQuote(10,28,book),56),happens(acceptQuote(30,6,book),56),happens(acceptQuote(20,42,book),56),happens(acceptQuote(30,42,book),56),happens(acceptQuote(40,39,book),56),happens(acceptQuote(40,27,book),56),happens(presentQuote(10,32,book),61),happens(presentQuote(10,16,book),61),happens(presentQuote(40,41,book),61),happens(presentQuote(30,1,book),61),happens(presentQuote(40,11,book),61),happens(presentQuote(40,31,book),61),happens(presentQuote(10,2,book),61),happens(presentQuote(0,5,book),61),happens(presentQuote(20,32,book),61),happens(presentQuote(40,34,book),61),happens(presentQuote(20,44,book),61),happens(presentQuote(0,16,book),61),happens(presentQuote(0,25,book),61),happens(presentQuote(0,13,book),61),happens(presentQuote(30,2,book),61),happens(presentQuote(0,26,book),61),happens(presentQuote(30,43,book),61),happens(presentQuote(10,4,book),61),happens(presentQuote(40,26,book),61),happens(presentQuote(30,49,book),61),happens(presentQuote(30,31,book),61),happens(presentQuote(30,19,book),61),happens(presentQuote(0,23,book),61),happens(presentQuote(40,32,book),61),happens(presentQuote(0,35,book),61),happens(presentQuote(30,24,book),61),happens(presentQuote(20,15,book),61),happens(presentQuote(36,49,book),61),happens(presentQuote(48,14,book),61),happens(acceptQuote(30,19,book),66),happens(acceptQuote(40,38,book),66),happens(acceptQuote(40,11,book),66),happens(acceptQuote(10,4,book),66),happens(acceptQuote(30,46,book),66),happens(acceptQuote(30,37,book),66),happens(acceptQuote(40,20,book),66),happens(acceptQuote(40,46,book),66),happens(acceptQuote(20,29,book),66),happens(acceptQuote(40,44,book),66),happens(acceptQuote(30,2,book),66),happens(acceptQuote(10,31,book),66),happens(acceptQuote(10,1,book),66),happens(acceptQuote(0,38,book),66),happens(acceptQuote(20,8,book),66),happens(acceptQuote(30,19,book),66),happens(acceptQuote(10,5,book),66),happens(acceptQuote(0,20,book),66),happens(acceptQuote(30,23,book),66),happens(acceptQuote(40,38,book),66),happens(acceptQuote(10,32,book),66),happens(acceptQuote(30,49,book),66),happens(acceptQuote(20,40,book),66),happens(acceptQuote(0,19,book),66),happens(acceptQuote(0,29,book),66),happens(acceptQuote(10,38,book),66),happens(acceptQuote(0,32,book),66),happens(acceptQuote(0,26,book),66),happens(acceptQuote(20,28,book),66),happens(acceptQuote(40,10,book),66),happens(acceptQuote(20,28,book),66),happens(acceptQuote(0,16,book),66),happens(acceptQuote(40,41,book),66),happens(acceptQuote(20,23,book),66),happens(acceptQuote(20,32,book),66),happens(acceptQuote(20,49,book),66),happens(acceptQuote(0,8,book),66),happens(acceptQuote(20,26,book),66),happens(acceptQuote(20,43,book),66),happens(acceptQuote(30,49,book),66),happens(acceptQuote(10,43,book),66),happens(acceptQuote(0,14,book),66),happens(acceptQuote(40,22,book),66),happens(acceptQuote(30,31,book),66),happens(acceptQuote(0,32,book),66),happens(acceptQuote(10,38,book),66),happens(acceptQuote(10,46,book),66),happens(acceptQuote(20,16,book),66),happens(acceptQuote(20,38,book),66),happens(acceptQuote(0,23,book),66),happens(acceptQuote(10,49,book),66),happens(acceptQuote(30,14,book),66),happens(acceptQuote(30,20,book),66),happens(acceptQuote(30,1,book),66),happens(acceptQuote(40,37,book),66),happens(acceptQuote(40,2,book),66),happens(acceptQuote(40,10,book),66),happens(acceptQuote(0,22,book),66),happens(acceptQuote(40,49,book),66),happens(acceptQuote(10,13,book),66),happens(acceptQuote(40,17,book),66),happens(acceptQuote(20,5,book),66),happens(acceptQuote(20,34,book),66),happens(acceptQuote(30,43,book),66),happens(acceptQuote(40,16,book),66),happens(acceptQuote(0,5,book),66),happens(acceptQuote(20,15,book),66),happens(acceptQuote(30,21,book),66),happens(acceptQuote(10,9,book),66),happens(acceptQuote(10,39,book),66),happens(acceptQuote(10,48,book),66),happens(presentQuote(30,31,book),71),happens(presentQuote(10,43,book),71),happens(presentQuote(40,46,book),71),happens(presentQuote(30,47,book),71),happens(presentQuote(20,32,book),71),happens(presentQuote(10,10,book),71),happens(presentQuote(20,14,book),71),happens(presentQuote(10,26,book),71),happens(presentQuote(10,10,book),71),happens(presentQuote(10,4,book),71),happens(presentQuote(0,23,book),71),happens(presentQuote(30,22,book),71),happens(presentQuote(20,47,book),71),happens(presentQuote(10,25,book),71),happens(presentQuote(0,22,book),71),happens(presentQuote(30,34,book),71),happens(presentQuote(40,35,book),71),happens(presentQuote(0,34,book),71),happens(presentQuote(40,7,book),71),happens(presentQuote(10,22,book),71),happens(presentQuote(40,41,book),71),happens(presentQuote(40,23,book),71),happens(presentQuote(40,41,book),71),happens(presentQuote(40,7,book),71),happens(presentQuote(10,47,book),71),happens(presentQuote(20,39,book),71),happens(presentQuote(0,3,book),71),happens(presentQuote(27,32,book),71),happens(presentQuote(42,34,book),71),happens(acceptQuote(0,11,book),76),happens(acceptQuote(20,7,book),76),happens(acceptQuote(0,29,book),76),happens(acceptQuote(20,22,book),76),happens(acceptQuote(10,2,book),76),happens(acceptQuote(30,43,book),76),happens(acceptQuote(40,49,book),76),happens(acceptQuote(10,19,book),76),happens(acceptQuote(30,13,book),76),happens(acceptQuote(0,10,book),76),happens(acceptQuote(0,43,book),76),happens(acceptQuote(10,32,book),76),happens(acceptQuote(30,2,book),76),happens(acceptQuote(30,37,book),76),happens(acceptQuote(30,41,book),76),happens(acceptQuote(20,41,book),76),happens(acceptQuote(20,17,book),76),happens(acceptQuote(20,23,book),76),happens(acceptQuote(20,29,book),76),happens(acceptQuote(0,29,book),76),happens(acceptQuote(10,38,book),76),happens(acceptQuote(30,5,book),76),happens(acceptQuote(10,5,book),76),happens(acceptQuote(30,5,book),76),happens(acceptQuote(30,25,book),76),happens(acceptQuote(10,23,book),76),happens(acceptQuote(30,34,book),76),happens(acceptQuote(0,19,book),76),happens(acceptQuote(40,47,book),76),happens(acceptQuote(40,23,book),76),happens(acceptQuote(10,26,book),76),happens(acceptQuote(40,40,book),76),happens(acceptQuote(20,4,book),76),happens(acceptQuote(20,35,book),76),happens(acceptQuote(10,23,book),76),happens(acceptQuote(30,32,book),76),happens(acceptQuote(10,31,book),76),happens(acceptQuote(10,38,book),76),happens(acceptQuote(0,26,book),76),happens(acceptQuote(40,29,book),76),happens(acceptQuote(20,8,book),76),happens(acceptQuote(10,7,book),76),happens(acceptQuote(10,41,book),76),happens(acceptQuote(0,11,book),76),happens(acceptQuote(40,20,book),76),happens(acceptQuote(0,19,book),76),happens(acceptQuote(30,13,book),76),happens(acceptQuote(10,37,book),76),happens(acceptQuote(20,34,book),76),happens(acceptQuote(0,23,book),76),happens(acceptQuote(20,25,book),76),happens(acceptQuote(30,32,book),76),happens(acceptQuote(40,29,book),76),happens(acceptQuote(30,31,book),76),happens(acceptQuote(10,22,book),76),happens(acceptQuote(30,7,book),76),happens(acceptQuote(40,25,book),76),happens(acceptQuote(0,11,book),76),happens(acceptQuote(30,43,book),76),happens(acceptQuote(30,8,book),76),happens(acceptQuote(40,19,book),76),happens(acceptQuote(0,40,book),76),happens(acceptQuote(30,16,book),76),happens(acceptQuote(10,20,book),76),happens(acceptQuote(30,5,book),76),happens(acceptQuote(0,35,book),76),happens(acceptQuote(40,6,book),76),happens(acceptQuote(20,39,book),76),happens(acceptQuote(10,12,book),76),happens(acceptQuote(20,45,book),76),happens(acceptQuote(0,48,book),76),happens(presentQuote(30,31,book),81),happens(presentQuote(0,19,book),81),happens(presentQuote(40,32,book),81),happens(presentQuote(30,38,book),81),happens(presentQuote(10,43,book),81),happens(presentQuote(40,16,book),81),happens(presentQuote(10,8,book),81),happens(presentQuote(10,1,book),81),happens(presentQuote(20,32,book),81),happens(presentQuote(40,13,book),81),happens(presentQuote(30,23,book),81),happens(presentQuote(20,26,book),81),happens(presentQuote(30,37,book),81),happens(presentQuote(0,31,book),81),happens(presentQuote(20,37,book),81),happens(presentQuote(30,25,book),81),happens(presentQuote(10,4,book),81),happens(presentQuote(0,38,book),81),happens(presentQuote(20,11,book),81),happens(presentQuote(40,29,book),81),happens(presentQuote(20,19,book),81),happens(presentQuote(0,11,book),81),happens(presentQuote(10,1,book),81),happens(presentQuote(0,35,book),81),happens(presentQuote(10,25,book),81),happens(presentQuote(0,9,book),81),happens(presentQuote(40,42,book),81),happens(presentQuote(48,23,book),81),happens(presentQuote(6,25,book),81),happens(acceptQuote(40,14,book),86),happens(acceptQuote(30,8,book),86),happens(acceptQuote(20,25,book),86),happens(acceptQuote(10,37,book),86),happens(acceptQuote(0,16,book),86),happens(acceptQuote(10,29,book),86),happens(acceptQuote(30,2,book),86),happens(acceptQuote(0,32,book),86),happens(acceptQuote(40,37,book),86),happens(acceptQuote(10,31,book),86),happens(acceptQuote(20,8,book),86),happens(acceptQuote(40,46,book),86),happens(acceptQuote(30,26,book),86),happens(acceptQuote(10,22,book),86),happens(acceptQuote(0,1,book),86),happens(acceptQuote(0,23,book),86),happens(acceptQuote(10,5,book),86),happens(acceptQuote(20,41,book),86),happens(acceptQuote(30,17,book),86),happens(acceptQuote(10,1,book),86),happens(acceptQuote(30,19,book),86),happens(acceptQuote(10,28,book),86),happens(acceptQuote(40,26,book),86),happens(acceptQuote(10,1,book),86),happens(acceptQuote(10,28,book),86),happens(acceptQuote(20,44,book),86),happens(acceptQuote(20,14,book),86),happens(acceptQuote(0,22,book),86),happens(acceptQuote(0,10,book),86),happens(acceptQuote(30,29,book),86),happens(acceptQuote(20,16,book),86),happens(acceptQuote(40,26,book),86),happens(acceptQuote(20,43,book),86),happens(acceptQuote(40,44,book),86),happens(acceptQuote(0,35,book),86),happens(acceptQuote(20,32,book),86),happens(acceptQuote(10,43,book),86),happens(acceptQuote(40,22,book),86),happens(acceptQuote(30,25,book),86),happens(acceptQuote(0,40,book),86),happens(acceptQuote(10,4,book),86),happens(acceptQuote(0,35,book),86),happens(acceptQuote(0,44,book),86),happens(acceptQuote(40,4,book),86),happens(acceptQuote(10,17,book),86),happens(acceptQuote(0,10,book),86),happens(acceptQuote(0,7,book),86),happens(acceptQuote(30,4,book),86),happens(acceptQuote(20,22,book),86),happens(acceptQuote(40,40,book),86),happens(acceptQuote(40,25,book),86),happens(acceptQuote(0,19,book),86),happens(acceptQuote(10,1,book),86),happens(acceptQuote(40,32,book),86),happens(acceptQuote(10,35,book),86),happens(acceptQuote(30,7,book),86),happens(acceptQuote(20,35,book),86),happens(acceptQuote(40,35,book),86),happens(acceptQuote(30,5,book),86),happens(acceptQuote(20,32,book),86),happens(acceptQuote(30,37,book),86),happens(acceptQuote(0,20,book),86),happens(acceptQuote(20,41,book),86),happens(acceptQuote(0,10,book),86),happens(acceptQuote(0,2,book),86),happens(acceptQuote(20,13,book),86),happens(acceptQuote(30,15,book),86),happens(acceptQuote(0,27,book),86),happens(acceptQuote(40,15,book),86),happens(acceptQuote(10,39,book),86),happens(acceptQuote(10,36,book),86),happens(presentQuote(20,4,book),91),happens(presentQuote(30,11,book),91),happens(presentQuote(20,16,book),91),happens(presentQuote(20,47,book),91),happens(presentQuote(10,16,book),91),happens(presentQuote(20,25,book),91),happens(presentQuote(40,34,book),91),happens(presentQuote(30,7,book),91),happens(presentQuote(30,2,book),91),happens(presentQuote(20,16,book),91),happens(presentQuote(40,22,book),91),happens(presentQuote(0,35,book),91),happens(presentQuote(40,29,book),91),happens(presentQuote(40,2,book),91),happens(presentQuote(20,46,book),91),happens(presentQuote(10,47,book),91),happens(presentQuote(10,31,book),91),happens(presentQuote(30,40,book),91),happens(presentQuote(10,41,book),91),happens(presentQuote(30,34,book),91),happens(presentQuote(10,37,book),91),happens(presentQuote(30,17,book),91),happens(presentQuote(20,22,book),91),happens(presentQuote(40,22,book),91),happens(presentQuote(30,10,book),91),happens(presentQuote(30,33,book),91),happens(presentQuote(40,18,book),91),happens(presentQuote(9,23,book),91),happens(presentQuote(18,29,book),91),happens(acceptQuote(40,14,book),96),happens(acceptQuote(40,31,book),96),happens(acceptQuote(20,29,book),96),happens(acceptQuote(20,34,book),96),happens(acceptQuote(0,23,book),96),happens(acceptQuote(10,31,book),96),happens(acceptQuote(10,44,book),96),happens(acceptQuote(30,47,book),96),happens(acceptQuote(0,37,book),96),happens(acceptQuote(0,47,book),96),happens(acceptQuote(30,26,book),96),happens(acceptQuote(30,28,book),96),happens(acceptQuote(0,28,book),96),happens(acceptQuote(0,34,book),96),happens(acceptQuote(30,11,book),96),happens(acceptQuote(10,14,book),96),happens(acceptQuote(10,4,book),96),happens(acceptQuote(20,17,book),96),happens(acceptQuote(40,47,book),96),happens(acceptQuote(40,31,book),96),happens(acceptQuote(0,1,book),96),happens(acceptQuote(40,37,book),96),happens(acceptQuote(20,41,book),96),happens(acceptQuote(40,26,book),96),happens(acceptQuote(30,41,book),96),happens(acceptQuote(0,35,book),96),happens(acceptQuote(20,10,book),96),happens(acceptQuote(10,26,book),96),happens(acceptQuote(30,14,book),96),happens(acceptQuote(0,17,book),96),happens(acceptQuote(30,17,book),96),happens(acceptQuote(30,29,book),96),happens(acceptQuote(0,7,book),96),happens(acceptQuote(10,49,book),96),happens(acceptQuote(10,38,book),96),happens(acceptQuote(0,26,book),96),happens(acceptQuote(20,43,book),96),happens(acceptQuote(20,46,book),96),happens(acceptQuote(40,20,book),96),happens(acceptQuote(20,8,book),96),happens(acceptQuote(20,20,book),96),happens(acceptQuote(20,41,book),96),happens(acceptQuote(10,17,book),96),happens(acceptQuote(30,14,book),96),happens(acceptQuote(30,31,book),96),happens(acceptQuote(0,43,book),96),happens(acceptQuote(40,17,book),96),happens(acceptQuote(40,23,book),96),happens(acceptQuote(20,17,book),96),happens(acceptQuote(30,10,book),96),happens(acceptQuote(30,38,book),96),happens(acceptQuote(20,23,book),96),happens(acceptQuote(20,46,book),96),happens(acceptQuote(10,7,book),96),happens(acceptQuote(20,16,book),96),happens(acceptQuote(10,14,book),96),happens(acceptQuote(20,20,book),96),happens(acceptQuote(40,43,book),96),happens(acceptQuote(30,8,book),96),happens(acceptQuote(10,34,book),96),happens(acceptQuote(40,10,book),96),happens(acceptQuote(10,19,book),96),happens(acceptQuote(0,41,book),96),happens(acceptQuote(40,31,book),96),happens(acceptQuote(20,5,book),96),happens(acceptQuote(10,41,book),96),happens(acceptQuote(20,12,book),96),happens(acceptQuote(10,12,book),96),happens(acceptQuote(30,39,book),96),happens(acceptQuote(40,48,book),96),happens(acceptQuote(20,45,book),96)]),
	status.

merchant(33).
merchant(27).
merchant(40).
merchant(48).
merchant(12).
merchant(45).
merchant(6).
merchant(30).
merchant(10).
merchant(18).
merchant(0).
merchant(9).
merchant(3).
merchant(42).
merchant(36).
merchant(24).
merchant(20).
consumer(27).
consumer(39).
consumer(46).
consumer(22).
consumer(13).
consumer(45).
consumer(10).
consumer(42).
consumer(28).
consumer(7).
consumer(11).
consumer(33).
consumer(14).
consumer(48).
consumer(21).
consumer(19).
consumer(32).
consumer(23).
consumer(49).
consumer(4).
consumer(2).
consumer(1).
consumer(41).
consumer(34).
consumer(29).
consumer(5).
consumer(16).
consumer(36).
consumer(44).
consumer(20).
consumer(40).
consumer(35).
consumer(37).
consumer(38).
consumer(47).
consumer(12).
consumer(6).
consumer(25).
consumer(15).
consumer(18).
consumer(26).
consumer(8).
consumer(3).
consumer(9).
consumer(17).
consumer(24).
consumer(31).
consumer(43).
goods(book).

initiates(presentQuote(M,C,GD), quote(M,C,GD), _):-
	merchant(M), consumer(C), goods(GD).

terminates(acceptQuote(M,C,GD), quote(M,C,GD), _):-
	merchant(M), consumer(C), goods(GD).

%-----------------------------------------------------------------------------%
% Re-definition of inequality signs to include infinite quantities.
lt(A,B):-gt(B,A).
le(A,B):-ge(B,A).

gt(inf,B):- B\==inf,!.
gt(_,inf):-!,fail.
gt(A,B):- A>B.

ge(A,A):-!.
ge(A,B):-gt(A,B).
%-----------------------------------------------------------------------------%

%-----------------------------------------------------------------------------%
% Re-definition of setof predicate.
my_setof(A,B,C):-
	setof(A,B,C),!.
my_setof(_,_,[]).
%-----------------------------------------------------------------------------%

%-----------------------------------------------------------------------------%
%Takes the list of events without duplicates and orders them.
order_events(Trace,OTrace):-
	order_events(Trace,[],OTrace).
	
order_events([],OTrace,OTrace).
order_events([H|T],OPTrace,OTrace):-
	ordered_insert(OPTrace,H,OPTraceNew),
	order_events(T,OPTraceNew,OTrace).

ordered_insert([],H,[H]).
ordered_insert([happens(Ev1,T1)|Trace],happens(Ev,T),[happens(Ev,T),happens(Ev1,T1)|Trace]):-
	T=<T1,!.
ordered_insert([H1|Trace],H,[H1|NewTrace]):-
	ordered_insert(Trace,H,NewTrace).
%-----------------------------------------------------------------------------%

%-----------------------------------------------------------------------------%
% Generic E.C. predicates.
holds_at(F, T):-
	holds_from(F, T, _).
	
holds_from(F, T, T1):-
	mholds_for(F, [T1, T2]),
	gt(T, T1),
	le(T, T2).


initiates(start, F, T):-
	initially(F).
	
declip(F,T):-
	happens(E,T),
	initiates(E, F, T),
	\+ holds_at(F, T).

clip(F,T):-
	happens(E,T),
	terminates(E, F, T),
	holds_at(F, T).
%-----------------------------------------------------------------------------%

%-----------------------------------------------------------------------------%
% Starts the REC engine, calculating fluents the initial state.
start:-
	update([happens(start,-1)]).
%-----------------------------------------------------------------------------%

%-----------------------------------------------------------------------------%
% REC engine backbone.
update(ExtTrace):-
	remove_duplicates(ExtTrace,NExtTrace),
	order_events(NExtTrace,OTrace),
	manage_concurrency(OTrace, Trace),
	update_events(Trace).

update_events([]).
update_events([H|T]):-
	update_events(H),
	update_events(T).	
	
update_events([happens(E,T)|Events]):-
	future_trace(T,FTraceRaw),
	order_events(FTraceRaw,FTraceO),
	manage_concurrency(FTraceO,FTrace),
	roll_back(T),
	calculate_effects([[happens(E,T)|Events]|FTrace]).
%-----------------------------------------------------------------------------%

%-----------------------------------------------------------------------------%
% Given an input timepoint, returns a list of all events which happen after that.
future_trace(T,FTrace):-
	my_setof(H,happens_after(H,T),FTrace).

% Predicate used for the previous setof. Returns an event which appen after Tref.
happens_after(happens(E,T),Tref):-
	happens(E,T),
	T > Tref.
%-----------------------------------------------------------------------------%

%-----------------------------------------------------------------------------%
% Given a timepoint T:
% - it removes all the events that happen after
% - it removes all the MVIs that start to hold after
% - it opens all the fluents that are holding at T
roll_back(T):-
	truncate_trace(T),
	remove_future_MVIs(T),
	open_current_MVIs(T).
%-----------------------------------------------------------------------------%

%-----------------------------------------------------------------------------%
% Given an input timepoint, obtains the future trace relative to those events 
% (i.e. all the events happened after T) and retracts them.
truncate_trace(T):-
	future_trace(T,FTrace),
	remove_events(FTrace).

remove_events([]).
remove_events([H|Trace]):-
	retract(H),
	remove_events(Trace).
%-----------------------------------------------------------------------------%	
	
%-----------------------------------------------------------------------------%
% Given a certain timepoint, removes all the MVI that start to hold
% afterwards.
remove_future_MVIs(T):-
	my_setof(MVI,future_MVI(MVI,T),MVIs),
	remove_MVIs(MVIs).

% Predicate used in the previous setof. Returns an MVI which starts to hold after
% the timepoint reference (Tref).
future_MVI(mholds_for(F,[Ts,Te]),Tref):-
	mholds_for(F,[Ts,Te]),
	gt(Ts,Tref).
%-----------------------------------------------------------------------------%

remove_MVIs([]).
remove_MVIs([MVI|MVIs]):-
	retract(MVI),
	remove_MVIs(MVIs).

%-----------------------------------------------------------------------------%
% Given a certain timepoint, opens all the MVIs that hold during that timepoint.
open_current_MVIs(T):-
	my_setof(MVI,current_MVI(MVI,T),MVIs),
	open_MVIs(MVIs).

% Predicate used in the previous setof. Returns an MVI which holds at the
% reference timepoint (Tstart<Tref=<Tend).
current_MVI(mholds_for(F,[Ts,Te]),Tref):-
	mholds_for(F,[Ts,Te]),
	gt(Tref,Ts),
	le(Tref,Te).
%-----------------------------------------------------------------------------%

%-----------------------------------------------------------------------------%
% Takes a list of MVIs, retracts them, and asserts new ones.
% The new MVIs have the same starting timepoints, but the ending timepoints are
% replaced with "inf". This is the meaning opening an MVI.
open_MVIs([]).
open_MVIs([mholds_for(F,[Ts,Te])|MVIs]):-
	retract(mholds_for(F,[Ts,Te])),
	assert(mholds_for(F,[Ts,inf])),
	open_MVIs(MVIs).
%-----------------------------------------------------------------------------%			

%-----------------------------------------------------------------------------%
%Applies the calculate_effects_events predicate to every element of the event list
calculate_effects([]).
calculate_effects([H|T]):-
	calculate_effects_events(H),
	calculate_effects(T).

% This is the core mechanism of REC. Each event E in the list, which happens at T:
% -is asserted back into the database
% -is evaluated to find fluents clipped by that event (at T)
% 	-the clipped fluents are closed
% -is evaluated to find fluents de-clipped by that event (at T)
% 	-the de-clipped fluents are opened
calculate_effects_events([happens(E,T)|Events]):-
	assert_all([happens(E,T)|Events]),
	my_setof(F, clip(F,T),S),
	close_mvis(S,T),
	my_setof(F, declip(F,T),S2),
	open_mvis(S2,T).
%-----------------------------------------------------------------------------%

%-----------------------------------------------------------------------------%
% Takes a list of MVIs and closes them with respect to timepoint T.
% The meaning of closing an MVI that holds at T, is to retract it 
% (if it's open -> ending time = inf) and to assert a new MVI with
% ending time replaced with T.
close_mvis([],_).
close_mvis([F|Fs],T):-
	close_mvi(F,T),
	close_mvis(Fs,T).
	
close_mvi(F,T):-
	holds_from(F,T,T1),
	retract(mholds_for(F,[T1,inf])),
	assert(mholds_for(F,[T1,T])).
%-----------------------------------------------------------------------------%

%-----------------------------------------------------------------------------%
% Takes a list of MVIs and opens them. 
% The meaning of opening a fluent's MVI is to retract the previous MVI and to 
% assert a new MVI with the ending time set to "inf"
open_mvis([],_).
open_mvis([F|Fs],T):-
	open_mvi(F,T),
	open_mvis(Fs,T).

open_mvi(F,T):-
	assert(mholds_for(F,[T,inf])).
%-----------------------------------------------------------------------------%

%-----------------------------------------------------------------------------%
% Returns the MVIs for all the active fluents.
status:-
        %query the index
	findall(mholds_for(F,[T1,T2]),(mholds_for(F,[T1,T2]), write(F), write("["), write(T1), write(","), write(T2), write("]"), nl), _MVIs).


% Cleans the memory (trace and mvis)
reset:-
	retractall(happens(_,_)),
	retractall(mholds_for(_,_)).
%-----------------------------------------------------------------------------%
		
%-----------------------------------------------------------------------------%	
%Takes the ordered events list and returns a lists of lists.
%Every sublist is a list of events that happen in the same timepoint.
manage_concurrency([],[]).
manage_concurrency(L,[H|T]):-
	separate(L,H,TL),
	manage_concurrency(TL,T).
	
separate([happens(E,T)|Tail],HF,TF):-
	separate(Tail,[happens(E,T)],HF,TF).

separate([happens(E2,T)|Tail],[happens(E,T)|Tail2],HF,TF):-
		!,
		separate(Tail,[happens(E2,T),happens(E,T)|Tail2],HF,TF).
	
separate(L,HF,HF,L).
%-----------------------------------------------------------------------------%

%-----------------------------------------------------------------------------%
%Takes a list of happens predicates (raw trace) and removes duplicate events.
remove_duplicates([],[]).
remove_duplicates([happens(E,T)|Tail],L):-
	happens(E,T),!,
	remove_duplicates(Tail,L).
remove_duplicates([H|T],[H|T2]):-
	remove_duplicates(T,T2).
%-----------------------------------------------------------------------------%			

assert_all([]).
assert_all([H|T]):-
	assert(H),
	assert_all(T).
